name: Vercel Preview Deployment

on:
  push:
    branches-ignore:
      - main

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint -- --max-warnings=0

      - name: Run TypeScript checks
        run: pnpm exec tsc --noEmit

      - name: Verify Next.js build
        env:
          NODE_ENV: production
        run: pnpm run build

  deploy-preview:
    needs: verify
    runs-on: ubuntu-latest
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-status: ${{ steps.deploy.outputs.status }}
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: pnpm dlx npm@latest install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: |
          export VERCEL_TOKEN='${{ secrets.VERCEL_TOKEN }}'
          vercel pull --yes --environment=preview --token="$VERCEL_TOKEN"

      - name: Build Project Artifacts
        run: |
          export VERCEL_TOKEN='${{ secrets.VERCEL_TOKEN }}'
          vercel build --token="$VERCEL_TOKEN"

      - name: Deploy Project Artifacts
        id: deploy
        run: |
          export VERCEL_TOKEN='${{ secrets.VERCEL_TOKEN }}'
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token="$VERCEL_TOKEN")
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
          echo "Preview deployed to: $DEPLOYMENT_URL"

  create-pr-on-success:
    needs: deploy-preview
    runs-on: ubuntu-latest
    if: |
      success() && 
      github.ref == 'refs/heads/development' &&
      needs.deploy-preview.outputs.deployment-status == 'success'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_EXISTS=$(gh pr list --head development --base main --state open --json number --jq '.[0].number')
          if [ -z "$PR_EXISTS" ]; then
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_EXISTS" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "ğŸš€ Deploy: Development to Production" \
            --body "## ğŸ¯ Auto-Generated Pull Request

          This PR was automatically created after successful preview deployment.

          ### âœ… Preview Deployment
          - **Status**: Success
          - **URL**: ${{ needs.deploy-preview.outputs.deployment-url }}
          - **Branch**: \`development\`
          - **Target**: \`main\`

          ### ğŸ“‹ Checks Passed
          - âœ… ESLint validation
          - âœ… TypeScript compilation
          - âœ… Next.js build verification
          - âœ… Vercel preview deployment

          ### ğŸ” Review Checklist
          - [ ] Code changes reviewed
          - [ ] Preview deployment tested
          - [ ] No breaking changes
          - [ ] Documentation updated (if needed)

          ---
          **Generated by**: GitHub Actions
          **Workflow**: Preview Deployment
          **Commit**: \`${{ github.sha }}\`" \
            --base main \
            --head development

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ steps.check-pr.outputs.pr_number }} \
            --body "## âœ… New Preview Deployment Successful

          **Commit**: \`${{ github.sha }}\`
          **Deployment URL**: ${{ needs.deploy-preview.outputs.deployment-url }}
          **Branch**: \`development\`

          All CI checks passed successfully! Ready for review."
